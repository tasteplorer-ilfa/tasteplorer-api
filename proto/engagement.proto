syntax = "proto3";

package engagement;

// Ini baris penting untuk Go:
option go_package = "engagement-pb/pb;pb";

service EngagementService {
    rpc LikeRecipe (LikeRequest) returns (EngagementResponse);
    rpc CommentRecipe (CommentRequest) returns (EngagementResponse);
    rpc GrantPoint (PointRequest) returns (PointResponse);
    rpc TrackEvent (EventRequest) returns (EngagementResponse);
}

// ============================================================================
// User Suggestion Service (Instagram-style recommendations)
// ============================================================================
service UserSuggestionService {
    // Get personalized user suggestions based on social graph
    rpc GetSuggestedUsers (GetSuggestedUsersRequest) returns (GetSuggestedUsersResponse);
    
    // Get explanation for why a user was suggested
    rpc GetSuggestionReason (GetSuggestionReasonRequest) returns (GetSuggestionReasonResponse);
}

// ============================================================================
// Feed Service (Social Feed Feature)
// ============================================================================
service FeedService {
    // CRUD operations
    rpc CreateFeed (CreateFeedRequest) returns (CreateFeedResponse);
    rpc GetFeed (GetFeedRequest) returns (GetFeedResponse);
    rpc UpdateFeed (UpdateFeedRequest) returns (UpdateFeedResponse);
    rpc DeleteFeed (DeleteFeedRequest) returns (DeleteFeedResponse);
    
    // Listing operations with cursor pagination
    rpc ListHomeFeed (ListHomeFeedRequest) returns (ListHomeFeedResponse);
    rpc ListUserFeeds (ListUserFeedsRequest) returns (ListUserFeedsResponse);
}

// ============================================================================
// Follow Service (Social Graph - Followers & Following)
// ============================================================================
service FollowService {
    // Get list of users who follow the target user
    rpc ListFollowers (ListFollowersRequest) returns (ListFollowersResponse);
    
    // Get list of users that the target user follows
    rpc ListFollowing (ListFollowingRequest) returns (ListFollowingResponse);
}

message LikeRequest {
    string userId = 1;
    string recipeId = 2;
}

message CommentRequest {
    string userId = 1;
    string recipeId = 2;
    string comment = 3;
}

message PointRequest {
    string userId = 1;
    int32 amount = 2;
    string action = 3;
}

message EventRequest {
    int32 userId = 1;
    string eventName = 2;
}

message EngagementResponse {
    bool success = 1;
    string message = 2;
    bool is_liked = 3;
}

message PointResponse {
    bool success = 1;
    int32 totalPoints = 2;
}

message GetSuggestedUsersRequest {
    int32 limit = 1;
    int32 offset = 2;
}

message GetSuggestedUsersResponse {
    repeated SuggestedUser users = 1;
    int32 total_count = 2;
    bool has_more = 3;
}

message SuggestedUser {
    string user_id = 1;
    string username = 2;
    string full_name = 3;
    string profile_image_url = 4;
    int32 follower_count = 5;
    int32 mutual_follower_count = 6;
    repeated string mutual_connection_usernames = 7;
    float suggestion_score = 8;
    string suggestion_reason = 9;
}

message GetSuggestionReasonRequest {
    string target_user_id = 1;
}

message GetSuggestionReasonResponse {
    bool success = 1;
    string reason = 2;
    ReasonDetails details = 3;
}

message ReasonDetails {
    int32 mutual_followers = 1;
    int32 shared_following = 2;
    repeated string connection_usernames = 3;
}

// ============================================================================
// Feed Messages
// ============================================================================

message CreateFeedRequest {
    // Note: user_id comes from authenticated context (JWT metadata)
    string content = 1;
    int32 recipe_id = 2;  // Optional: 0 means no recipe link
    repeated FeedImageInput images = 3;
}

message FeedImageInput {
    string image_url = 1;
    int32 position = 2;
}

message CreateFeedResponse {
    bool success = 1;
    string message = 2;
    Feed feed = 3;
}

message GetFeedRequest {
    string feed_id = 1;  // UUID string
}

message GetFeedResponse {
    bool success = 1;
    string message = 2;
    Feed feed = 3;
}

message UpdateFeedRequest {
    string feed_id = 1;  // UUID string
    string content = 2;
    int32 recipe_id = 3;  // Optional: 0 means no recipe link
    repeated FeedImageInput images = 4;
    
}

message UpdateFeedResponse {
    bool success = 1;
    string message = 2;
    Feed feed = 3;
}

message DeleteFeedRequest {
    string feed_id = 1;  // UUID string
}

message DeleteFeedResponse {
    bool success = 1;
    string message = 2;
}

message ListHomeFeedRequest {
    // Note: user_id comes from authenticated context (JWT)
    string cursor = 1;  // Opaque cursor (Base64 encoded)
    int32 limit = 2;    // Max 100, default 20
}

message ListHomeFeedResponse {
    bool success = 1;
    repeated Feed feeds = 2;
    string next_cursor = 3;  // Empty if no more pages
    bool has_more = 4;
}

message ListUserFeedsRequest {
    int32 target_user_id = 1;  // User whose feeds to retrieve
    string cursor = 2;
    int32 limit = 3;
}

message ListUserFeedsResponse {
    bool success = 1;
    repeated Feed feeds = 2;
    string next_cursor = 3;
    bool has_more = 4;
}

// Feed user information
message FeedUser {
    int32 id = 1;
    string username = 2;
    string profile_image_url = 3;
}

// Feed recipe information
message FeedRecipe {
    int32 id = 1;
    string title = 2;
}

message Feed {
    string id = 1;  // UUID string
    FeedUser user = 2;  // Changed from user_id to user object
    FeedRecipe recipe = 3;  // Changed from int32 recipe_id to FeedRecipe object (nullable)
    string content = 4;
    string created_at = 5;  // RFC3339 format
    string updated_at = 6;  // RFC3339 format
    repeated FeedImage images = 7;
}

message FeedImage {
    string id = 1;  // UUID string
    string image_url = 2;
    int32 position = 3;
}

// ============================================================================
// Follow Service Messages
// ============================================================================

message UserSummary {
    int32 id = 1;
    string username = 2;
    string fullname = 3;
    string image = 4;
    bool is_followed_by_me = 5;  // Whether viewer follows this user
    bool is_me = 6;               // Whether this user is the viewer (user_id == viewer_id)
}

// Pagination metadata for cursor-based pagination
message PageInfo {
    int64 next_cursor = 1;  // ID-based cursor for next page
    bool has_next = 2;      // Whether more results exist
}

// Request to list followers of a user
message ListFollowersRequest {
    int32 user_id = 1;     // Target user whose followers to retrieve
    int32 viewer_id = 2;   // Authenticated user making the request
    int32 limit = 3;       // Max results per page (default 20, max 100)
    int64 cursor = 4;      // Optional: user_follows.id for pagination
}

// Response containing list of followers
message ListFollowersResponse {
    repeated UserSummary users = 1;
    PageInfo page_info = 2;
}

// Request to list users that target user follows
message ListFollowingRequest {
    int32 user_id = 1;     // Target user whose following to retrieve
    int32 viewer_id = 2;   // Authenticated user making the request
    int32 limit = 3;       // Max results per page (default 20, max 100)
    int64 cursor = 4;      // Optional: user_follows.id for pagination
}

// Response containing list of following users
message ListFollowingResponse {
    repeated UserSummary users = 1;
    PageInfo page_info = 2;
}
